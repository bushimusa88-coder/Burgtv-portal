<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BurgTV Portal</title>
  <link rel="icon" href="favicon.ico"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0a0a0b;color:#fff;margin:0;padding:24px}
    .card{max-width:780px;margin:0 auto;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:24px}
    h1{margin:0 0 16px}
    label{display:block;margin:12px 0 6px;color:#bbb;font-size:13px;text-transform:uppercase;letter-spacing:.08em}
    input,select{width:100%;padding:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);border-radius:10px;color:#fff}
    button{padding:12px 18px;border:0;border-radius:10px;background:linear-gradient(135deg,#B94A8E,#7B4397);color:#fff;font-weight:600;cursor:pointer;margin-top:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .status{margin-top:16px;padding:10px;border-radius:10px;background:rgba(255,255,255,.06)}
    .ok{color:#10b981}.err{color:#ef4444}
  </style>
  <!-- hCaptcha (test sitekey by default) -->
  <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
</head>
<body>
  <div class="card">
    <h1>Register Device</h1>
    <form id="f">
      <label>Device Type</label>
      <select id="device_type" required>
        <option value="">Select…</option>
        <option value="firetv">Fire TV</option>
        <option value="samsung">Samsung TV</option>
        <option value="lg">LG TV</option>
        <option value="appletv">Apple TV</option>
        <option value="android">Android TV</option>
        <option value="ios">iPhone/iPad</option>
      </select>

      <div class="row">
        <div>
          <label>MAC Address</label>
          <input id="mac" placeholder="AA:BB:CC:DD:EE:FF" required/>
        </div>
        <div>
          <label>Device Name (optional)</label>
          <input id="name" placeholder="Living Room TV"/>
        </div>
      </div>

      <label>M3U Playlist URL</label>
      <input id="m3u" placeholder="https://example.com/playlist.m3u" required/>

      <label>EPG URL (optional)</label>
      <input id="epg" placeholder="https://example.com/epg.xml"/>

      <!-- hCaptcha widget -->
      <div style="margin-top:12px" class="h-captcha" data-sitekey="10000000-ffff-ffff-ffff-000000000001"></div>

      <button type="submit">Save Device</button>
    </form>

    <div id="msg" class="status"></div>
  </div>

  <script>
    const API_BASE = (window.location.hostname === 'app.burgtv.com')
      ? 'https://api.burgtv.com'
      : 'https://burgtv-hg7cd958b-musas-projects-35ccad54.vercel.app';

    function validMAC(m){
      return /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/.test(m||'')
    }

    const form = document.getElementById('f');
    const msg = document.getElementById('msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = 'Submitting…';

      const mac = document.getElementById('mac').value.trim();
      const device_type = document.getElementById('device_type').value;
      const device_name = document.getElementById('name').value.trim();
      const m3u_url = document.getElementById('m3u').value.trim();
      const epg_url = document.getElementById('epg').value.trim();

      if (!validMAC(mac)) { msg.innerHTML = '<span class="err">Invalid MAC</span>'; return; }
      if (!m3u_url.startsWith('http')) { msg.innerHTML = '<span class="err">Invalid M3U URL</span>'; return; }

      // get hCaptcha token from widget
      const token = window.hcaptcha?.getResponse();
      if (!token) { msg.innerHTML = '<span class="err">Please complete captcha</span>'; return; }

      try {
        const r = await fetch(`${API_BASE}/api/register_public`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mac_address: mac,
            device_type,
            device_name,
            m3u_url,
            epg_url,
            hcaptcha_token: token
          })
        });
        const j = await r.json();
        if (!r.ok || !j.success) {
          msg.innerHTML = '<span class="err">Error: ' + (j.error || r.statusText) + '</span>';
        } else {
          msg.innerHTML = '<span class="ok">✅ Registered! Token issued.</span>';
          form.reset();
          window.hcaptcha.reset(); // reset captcha
        }
      } catch (err) {
        console.error(err);
        msg.innerHTML = '<span class="err">Network error</span>';
      }
    });
  </script>
</body>
</html>
