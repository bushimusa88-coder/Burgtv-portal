<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BurgTV Portal</title>
  <link rel="icon" href="assets/favicon.png">
  <style>
    body{margin:0;background:#0a0a0b;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .container{max-width:1000px;margin:0 auto;padding:24px}
    header{position:sticky;top:0;background:#111113cc;backdrop-filter:blur(16px);border-bottom:1px solid rgba(255,255,255,.08);z-index:10}
    .logo{display:flex;align-items:center;gap:12px}
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:24px;margin:16px 0}
    input,select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff}
    label{font-size:12px;letter-spacing:.08em;color:#a0a0a8;text-transform:uppercase}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    button{padding:12px 18px;border:0;border-radius:12px;font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,#B94A8E,#7B4397);color:#fff}
    .status{padding:6px 10px;border-radius:8px;font-weight:600;font-size:13px;display:inline-block}
    .ok{background:rgba(16,185,129,.15);color:#10b981}
    .warn{background:rgba(245,158,11,.15);color:#f59e0b}
    .err{background:rgba(239,68,68,.15);color:#ef4444}
    .muted{color:#a0a0a8}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .device{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px}
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;justify-content:space-between;align-items:center;gap:16px">
      <div class="logo"><img src="assets/logo.svg" height="40" alt="BurgTV"/><strong>BurgTV Portal</strong></div>
      <div class="muted">API: <span id="apiStatus">checking…</span></div>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <h2>Connect a device</h2>
      <p class="muted">Compila i campi e registra il tuo dispositivo. Il trial è <strong id="trialState">disattivo</strong>.</p>
      <form id="registerForm">
        <div class="row">
          <div>
            <label>Device Type</label>
            <select id="device_type" required>
              <option value="">Select device…</option>
              <option value="firetv">Amazon Fire TV</option>
              <option value="samsung">Samsung TV</option>
              <option value="lg">LG TV</option>
              <option value="appletv">Apple TV</option>
              <option value="android">Android TV</option>
              <option value="ios">iPhone/iPad</option>
            </select>
          </div>
          <div>
            <label>Device Name (optional)</label>
            <input id="device_name" placeholder="Living Room TV"/>
          </div>
        </div>
        <div class="row">
          <div>
            <label>MAC Address</label>
            <input id="mac_address" placeholder="AA:BB:CC:DD:EE:FF" required/>
          </div>
          <div>
            <label>M3U URL</label>
            <input id="m3u_url" placeholder="https://example.com/playlist.m3u" required/>
          </div>
        </div>
        <div class="row">
          <div>
            <label>EPG URL (optional)</label>
            <input id="epg_url" placeholder="https://example.com/epg.xml"/>
          </div>
          <div style="display:flex;align-items:flex-end;justify-content:flex-end">
            <button class="btn-primary" type="submit">Save Device</button>
          </div>
        </div>
      </form>
      <div id="regMsg" class="muted"></div>
    </div>

    <div class="card">
      <h2>Test playlist</h2>
      <div class="row">
        <div>
          <label>MAC Address</label>
          <input id="test_mac" placeholder="AA:BB:CC:DD:EE:FF"/>
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn-primary" id="btnTest">Check</button>
        </div>
      </div>
      <pre id="testOut" style="white-space:pre-wrap;margin-top:12px;background:rgba(0,0,0,.4);padding:12px;border-radius:8px"></pre>
    </div>

    <div class="card">
      <h2>Devices (local)</h2>
      <div id="devices" class="grid"></div>
    </div>
  </div>

  <script>
    // CONFIG
    const API_BASE = (location.hostname.includes('burgtv.com') ? 'https://api.burgtv.com' : '').trim();

    async function ping() {
      try {
        const r = await fetch((API_BASE || '') + '/api');
        const j = await r.json();
        document.getElementById('apiStatus').innerText = j.status + ' • v' + j.version;
        document.getElementById('trialState').innerText = j.trial_enabled ? 'attivo' : 'disattivo';
      } catch(e) {
        document.getElementById('apiStatus').innerText = 'offline';
      }
    }

    function addLocalDevice(d) {
      const key = 'devices_local';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.push(d);
      localStorage.setItem(key, JSON.stringify(arr));
      renderLocalDevices();
    }

    function renderLocalDevices() {
      const key = 'devices_local';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      const c = document.getElementById('devices');
      c.innerHTML = arr.map(d => \`
        <div class="device">
          <div><strong>\${d.device_type}</strong> • <span class="muted">\${d.device_name||'-'}</span></div>
          <div style="margin-top:6px"><code>\${d.mac_address}</code></div>
          <div class="muted" style="margin-top:6px">M3U: \${d.m3u_url}</div>
        </div>\`
      ).join('') || '<div class="muted">Nessun dispositivo locale</div>';
    }

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        mac_address: document.getElementById('mac_address').value.trim(),
        device_type: document.getElementById('device_type').value,
        device_name: document.getElementById('device_name').value.trim(),
        m3u_url: document.getElementById('m3u_url').value.trim(),
        epg_url: document.getElementById('epg_url').value.trim()
      };
      document.getElementById('regMsg').innerText = 'Invio…';
      try {
        const r = await fetch((API_BASE || '') + '/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (j.success) {
          document.getElementById('regMsg').innerHTML = '<span class="status ok">Registrato ✔</span>';
          addLocalDevice(payload);
          (e.target).reset();
        } else {
          document.getElementById('regMsg').innerHTML = '<span class="status err">Errore: ' + (j.error || 'unknown') + '</span>';
        }
      } catch (err) {
        document.getElementById('regMsg').innerHTML = '<span class="status err">Network error</span>';
      }
    });

    document.getElementById('btnTest').addEventListener('click', async () => {
      const mac = document.getElementById('test_mac').value.trim();
      if (!mac) return;
      document.getElementById('testOut').innerText = 'Loading…';
      try {
        const r = await fetch((API_BASE || '') + '/api/playlist?mac=' + encodeURIComponent(mac));
        const j = await r.json();
        document.getElementById('testOut').innerText = JSON.stringify(j, null, 2);
      } catch (e) {
        document.getElementById('testOut').innerText = 'Errore rete';
      }
    });

    ping();
    renderLocalDevices();
  </script>
</body>
</html>
