<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BurgTV Portal - Gestione Dispositivi</title>

  <!-- Favicon/Logo (lascia i tuoi nomi/file attuali) -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="favicon.png">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg:#0b0b0c;--text:#fff;--muted:#c9c9d1;
      --accent:#B94A8E;--accent2:#7B4397;
      --header-bg:rgba(255,255,255,0.04);--border:rgba(255,255,255,0.1)
    }
    body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;line-height:1.6;min-height:100vh}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{background:var(--header-bg);border-bottom:1px solid var(--border);padding:30px 0;margin-bottom:40px}
    .header-inner{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .logo{display:flex;align-items:center;justify-content:center;gap:16px;width:100%}
    .logo img{height:100px;width:auto;filter:drop-shadow(0 6px 20px rgba(185,74,142,.4))}
    .lang-switch{position:absolute;right:20px;top:20px;display:flex;gap:8px}
    .lang-btn{background:transparent;border:1px solid var(--border);color:var(--muted);padding:6px 10px;border-radius:8px;cursor:pointer}
    .lang-btn.active{border-color:var(--accent);color:#fff}
    .tabs{display:flex;gap:10px;margin-bottom:30px;border-bottom:1px solid var(--border);padding-bottom:10px;flex-wrap:wrap}
    .tab{padding:10px 20px;background:transparent;color:var(--muted);border:none;cursor:pointer;font-size:16px;transition:.3s}
    .tab.active{color:var(--accent);border-bottom:2px solid var(--accent)}
    .panel{display:none}.panel.active{display:block}
    .card{background:var(--header-bg);border:1px solid var(--border);border-radius:15px;padding:30px;margin-bottom:30px}
    .form-group{margin-bottom:20px}
    label{display:block;margin-bottom:8px;color:var(--muted);font-size:14px;text-transform:uppercase}
    input,select{width:100%;padding:12px;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:16px}
    input:focus,select:focus{outline:none;border-color:var(--accent)}
    .btn{background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 100%);color:white;padding:12px 30px;border:none;border-radius:25px;font-size:16px;font-weight:600;cursor:pointer;transition:.3s}
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(185,74,142,.3)}
    .device-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:30px}
    .device-card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;padding:20px;transition:.3s}
    .device-card:hover{border-color:var(--accent);transform:translateY(-5px)}
    .device-mac{font-family:monospace;font-size:18px;color:var(--accent);margin:10px 0}
    .device-type{display:inline-block;padding:5px 10px;background:rgba(185,74,142,.2);border-radius:5px;font-size:12px;margin-bottom:10px}
    .status{display:inline-block;padding:5px 10px;border-radius:5px;font-size:12px}
    .status.active{background:rgba(76,175,80,.2);color:#4CAF50}
    .status.trial{background:rgba(255,152,0,.2);color:#FF9800}
    .alert{background:rgba(185,74,142,.1);border:1px solid var(--accent);border-radius:10px;padding:20px;margin-bottom:20px}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:linear-gradient(135deg,rgba(185,74,142,.1) 0%,rgba(123,67,151,.1) 100%);border:1px solid var(--accent);border-radius:10px;padding:20px;text-align:center}
    .stat-number{font-size:2rem;font-weight:bold;color:var(--accent)}
    .stat-label{color:var(--muted);font-size:14px}
    .toast{position:fixed;right:16px;bottom:16px;background:#141416;border:1px solid var(--border);color:#fff;padding:12px 16px;border-radius:10px;opacity:0;pointer-events:none;transform:translateY(10px);transition:.3s}
    .toast.show{opacity:1;pointer-events:auto;transform:translateY(0)}
  </style>
</head>
<body>
  <header>
    <div class="container header-inner">
      <div class="logo">
        <img src="logo.svg" alt="BurgTV" />
      </div>
      <div class="lang-switch">
        <button class="lang-btn" id="btn-it">IT ğŸ‡®ğŸ‡¹</button>
        <button class="lang-btn" id="btn-en">EN ğŸ‡¬ğŸ‡§</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Statistiche -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="totalDevices">0</div>
        <div class="stat-label" data-i18n="stats.totalDevices">Dispositivi Totali</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="activeDevices">0</div>
        <div class="stat-label" data-i18n="stats.activeNow">Attivi Ora</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="trialDays">7</div>
        <div class="stat-label" data-i18n="stats.trialDays">Giorni Trial</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalPlaylists">0</div>
        <div class="stat-label" data-i18n="stats.playlists">Playlist Caricate</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="devices" data-i18n="tabs.devices">ğŸ“º Dispositivi</button>
      <button class="tab" data-tab="add" data-i18n="tabs.add">â• Aggiungi Dispositivo</button>
      <button class="tab" data-tab="account" data-i18n="tabs.account">ğŸ‘¤ Account</button>
      <button class="tab" data-tab="help" data-i18n="tabs.help">â“ Aiuto</button>
    </div>

    <!-- Panel Dispositivi -->
    <div id="devices" class="panel active">
      <div class="card">
        <h2 data-i18n="devices.title">I Tuoi Dispositivi</h2>
        <div class="device-list" id="deviceList">
          <!-- VerrÃ  popolato via JS -->
        </div>
      </div>
    </div>

    <!-- Panel Aggiungi -->
    <div id="add" class="panel">
      <div class="card">
        <h2 data-i18n="add.title">Collega Nuovo Dispositivo</h2>
        <form id="addDeviceForm">
          <div class="form-group">
            <label data-i18n="add.type">Tipo di Dispositivo</label>
            <select id="deviceType" required>
              <option value="" data-i18n="add.select">Seleziona...</option>
              <option value="firestick">ğŸ”¥ Amazon Fire Stick</option>
              <option value="samsung">ğŸ“º Samsung TV (Tizen)</option>
              <option value="lg">ğŸ“º LG TV (webOS)</option>
              <option value="android">ğŸ“± Android Phone/Tablet</option>
              <option value="ios">ğŸ“± iPhone/iPad</option>
            </select>
          </div>

          <div class="form-group">
            <label data-i18n="add.mac">MAC Address / Device ID</label>
            <input type="text" id="macAddress" placeholder="AA:BB:CC:DD:EE:FF" required>
            <small style="color:var(--muted)" data-i18n="add.macHelp">Lo trovi nell'app sul dispositivo</small>
          </div>

          <div class="form-group">
            <label data-i18n="add.m3u">URL Playlist M3U</label>
            <input type="url" id="m3uUrl" placeholder="http://esempio.com/playlist.m3u" required>
          </div>

          <div class="form-group">
            <label data-i18n="add.epg">URL EPG (Opzionale)</label>
            <input type="url" id="epgUrl" placeholder="http://esempio.com/epg.xml">
          </div>

          <div class="form-group">
            <label data-i18n="add.name">Nome Dispositivo (Opz.)</label>
            <input type="text" id="deviceName" placeholder="TV Salotto">
          </div>

          <button type="submit" class="btn" data-i18n="add.save">ğŸ’¾ Salva Dispositivo</button>
        </form>
      </div>

      <div class="alert">
        <strong data-i18n="add.whereTitle">ğŸ“± Come trovare il MAC Address:</strong>
        <ul style="margin-left:20px;margin-top:10px;">
          <li><strong>Fire Stick:</strong> <span data-i18n="add.whereFire">Apri l'app â†’ Impostazioni â†’ Info</span></li>
          <li><strong>Samsung TV:</strong> <span data-i18n="add.whereSamsung">Menu â†’ Rete â†’ Stato Rete â†’ Indirizzo MAC</span></li>
          <li><strong>LG TV:</strong> <span data-i18n="add.whereLg">Impostazioni â†’ Tutte â†’ Rete â†’ Info Rete</span></li>
          <li><strong>Mobile:</strong> <span data-i18n="add.whereMobile">L'app genera un ID univoco automaticamente</span></li>
        </ul>
      </div>
    </div>

    <!-- Panel Account -->
    <div id="account" class="panel">
      <div class="card">
        <h2 data-i18n="account.title">Il Tuo Account</h2>
        <div class="form-group">
          <label data-i18n="account.email">Email</label>
          <input type="email" value="utente@esempio.com" readonly>
        </div>
        <div class="form-group">
          <label data-i18n="account.status">Stato</label>
          <div class="status trial" id="accountStatus">Prova Gratuita - 7 giorni rimanenti</div>
        </div>
        <div class="form-group">
          <label data-i18n="account.devices">Dispositivi</label>
          <div id="accountDevices">0</div>
        </div>
        <button class="btn" data-i18n="account.upgrade">ğŸš€ Upgrade a Premium - â‚¬5.99</button>
      </div>
    </div>

    <!-- Panel Aiuto -->
    <div id="help" class="panel">
      <div class="card">
        <h2 data-i18n="help.title">Come Configurare</h2>
        <ol style="margin-left:20px;line-height:2;">
          <li data-i18n="help.step1"><strong>Scarica l'app</strong> sul tuo dispositivo (TV, Fire Stick, Mobile)</li>
          <li data-i18n="help.step2"><strong>Apri l'app</strong> e trova il MAC Address mostrato</li>
          <li data-i18n="help.step3"><strong>Vieni qui</strong> e clicca "Aggiungi Dispositivo"</li>
          <li data-i18n="help.step4"><strong>Inserisci</strong> il MAC Address e l'URL della tua playlist M3U</li>
          <li data-i18n="help.step5"><strong>Salva</strong> e torna all'app - si sincronizzerÃ  automaticamente!</li>
        </ol>
      </div>

      <div class="card">
        <h2 data-i18n="help.download">Download App</h2>
        <p style="margin-bottom:20px;" data-i18n="help.downloadText">Scarica l'app per il tuo dispositivo:</p>
        <div style="display:grid;gap:10px;">
          <button class="btn" onclick="alert('Link Fire Stick in arrivo')" data-i18n="help.fire">ğŸ”¥ Amazon Fire Stick</button>
          <button class="btn" onclick="alert('Link Samsung TV in arrivo')" data-i18n="help.samsung">ğŸ“º Samsung TV</button>
          <button class="btn" onclick="alert('Link LG TV in arrivo')" data-i18n="help.lg">ğŸ“º LG TV</button>
          <button class="btn" onclick="alert('Link Android in arrivo')" data-i18n="help.android">ğŸ“± Android</button>
          <button class="btn" onclick="alert('Link iOS in arrivo')" data-i18n="help.ios">ğŸ“± iOS</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">OK</div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const API_BASE = 'https://api.burgtv.com'; // â¬…ï¸ Cambia con il tuo dominio API

    // =========================
    // I18N
    // =========================
    const t = {
      it: {
        stats:{totalDevices:'Dispositivi Totali',activeNow:'Attivi Ora',trialDays:'Giorni Trial',playlists:'Playlist Caricate'},
        tabs:{devices:'ğŸ“º Dispositivi',add:'â• Aggiungi Dispositivo',account:'ğŸ‘¤ Account',help:'â“ Aiuto'},
        devices:{title:'I Tuoi Dispositivi'},
        add:{
          title:'Collega Nuovo Dispositivo',
          type:'Tipo di Dispositivo', select:'Seleziona...',
          mac:'MAC Address / Device ID', macHelp:"Lo trovi nell'app sul dispositivo",
          m3u:'URL Playlist M3U', epg:'URL EPG (Opzionale)', name:'Nome Dispositivo (Opz.)',
          save:'ğŸ’¾ Salva Dispositivo',
          whereTitle:'ğŸ“± Come trovare il MAC Address:',
          whereFire:'Apri lâ€™app â†’ Impostazioni â†’ Info',
          whereSamsung:'Menu â†’ Rete â†’ Stato Rete â†’ Indirizzo MAC',
          whereLg:'Impostazioni â†’ Tutte â†’ Rete â†’ Info Rete',
          whereMobile:'Lâ€™app genera un ID univoco automaticamente'
        },
        account:{title:'Il Tuo Account',email:'Email',status:'Stato',devices:'Dispositivi',upgrade:'ğŸš€ Upgrade a Premium - â‚¬5.99'},
        help:{
          title:'Come Configurare',
          step1:'<strong>Scarica l\'app</strong> sul tuo dispositivo (TV, Fire Stick, Mobile)',
          step2:'<strong>Apri l\'app</strong> e trova il MAC Address mostrato',
          step3:'<strong>Vieni qui</strong> e clicca "Aggiungi Dispositivo"',
          step4:'<strong>Inserisci</strong> il MAC Address e l\'URL della tua playlist M3U',
          step5:'<strong>Salva</strong> e torna all\'app - si sincronizzerÃ  automaticamente!',
          download:'Download App',downloadText:'Scarica lâ€™app per il tuo dispositivo:',
          fire:'ğŸ”¥ Amazon Fire Stick', samsung:'ğŸ“º Samsung TV', lg:'ğŸ“º LG TV', android:'ğŸ“± Android', ios:'ğŸ“± iOS'
        },
        toastSaved:'âœ… Dispositivo collegato con successo',
        toastError:'âŒ Errore: controlla i dati o riprova'
      },
      en: {
        stats:{totalDevices:'Total Devices',activeNow:'Active Now',trialDays:'Trial Days',playlists:'Playlists Loaded'},
        tabs:{devices:'ğŸ“º Devices',add:'â• Add Device',account:'ğŸ‘¤ Account',help:'â“ Help'},
        devices:{title:'Your Devices'},
        add:{
          title:'Link a New Device',
          type:'Device Type', select:'Select...',
          mac:'MAC Address / Device ID', macHelp:"Youâ€™ll find it inside the app on the device",
          m3u:'M3U Playlist URL', epg:'EPG URL (Optional)', name:'Device Name (Optional)',
          save:'ğŸ’¾ Save Device',
          whereTitle:'ğŸ“± How to find the MAC Address:',
          whereFire:'Open the app â†’ Settings â†’ Info',
          whereSamsung:'Menu â†’ Network â†’ Network Status â†’ MAC Address',
          whereLg:'Settings â†’ All â†’ Network â†’ Network Info',
          whereMobile:'The app automatically generates a unique ID'
        },
        account:{title:'Your Account',email:'Email',status:'Status',devices:'Devices',upgrade:'ğŸš€ Upgrade to Premium - â‚¬5.99'},
        help:{
          title:'How to Set Up',
          step1:'<strong>Download the app</strong> on your device (TV, Fire Stick, Mobile)',
          step2:'<strong>Open the app</strong> and find the displayed MAC Address',
          step3:'<strong>Come here</strong> and click "Add Device"',
          step4:'<strong>Enter</strong> the MAC Address and your M3U playlist URL',
          step5:'<strong>Save</strong> and go back to the app â€” it will sync automatically!',
          download:'Download App',downloadText:'Download the app for your device:',
          fire:'ğŸ”¥ Amazon Fire Stick', samsung:'ğŸ“º Samsung TV', lg:'ğŸ“º LG TV', android:'ğŸ“± Android', ios:'ğŸ“± iOS'
        },
        toastSaved:'âœ… Device linked successfully',
        toastError:'âŒ Error: check the data or try again'
      }
    };
    function applyLang(lang){
      document.documentElement.lang = lang;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const path = el.getAttribute('data-i18n').split('.');
        let val = t[lang];
        for(const k of path){ val = val?.[k]; }
        if(typeof val==='string') el.innerHTML = val || '';
      });
      document.getElementById('btn-it').classList.toggle('active', lang==='it');
      document.getElementById('btn-en').classList.toggle('active', lang==='en');
      localStorage.setItem('lang', lang);
    }

    // =========================
    // Tabs
    // =========================
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        tab.classList.add('active');
        const name = tab.getAttribute('data-tab');
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById(name).classList.add('active');
      });
    });

    // =========================
    // Toast utilities
    // =========================
    function showToast(msg){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), 2500);
    }

    // =========================
    // Devices UI (client-side)
    // =========================
    function getIcon(type){
      const icons={firestick:'ğŸ”¥',samsung:'ğŸ“º',lg:'ğŸ“º',android:'ğŸ“±',ios:'ğŸ“±'};
      return icons[type]||'ğŸ“º';
    }
    function renderDevices(list){
      const holder = document.getElementById('deviceList');
      if(!list || !list.length){ holder.innerHTML = ''; return; }
      holder.innerHTML = list.map(d => `
        <div class="device-card">
          <div class="device-type">${getIcon(d.type)} ${d.type || ''}</div>
          <div class="device-mac">${d.mac}</div>
          <div>${d.m3uUrl ? 'Playlist: configurata' : 'Playlist: non configurata'}</div>
          <div class="status ${d.isActive ? 'active' : 'trial'}">${d.isActive ? 'Attivo' : 'Trial'}</div>
        </div>
      `).join('');
    }
    function updateStats(list){
      document.getElementById('totalDevices').textContent = list.length;
      document.getElementById('totalPlaylists').textContent = list.filter(x=>x.m3uUrl).length;
    }

    // =========================
    // Form submit â†’ API POST /devices/link
    // =========================
    const form = document.getElementById('addDeviceForm');
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const lang = localStorage.getItem('lang') || 'it';
      const device = {
        type: document.getElementById('deviceType').value,
        mac: document.getElementById('macAddress').value.trim(),
        m3uUrl: document.getElementById('m3uUrl').value.trim(),
        epgUrl: document.getElementById('epgUrl').value.trim() || undefined,
        name: document.getElementById('deviceName').value.trim()
      };
      const deviceId = device.mac; // usiamo MAC/ID come deviceId per l'API

      try{
        const r = await fetch(`${API_BASE}/api/devices/link`,{
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ deviceId, m3uUrl: device.m3uUrl, epgUrl: device.epgUrl })
        });
        const json = await r.json();

        if(!r.ok || json.error){
          showToast(t[lang].toastError);
          return;
        }

        // Recupera stato device dall'API
        let isActive = true;
        try{
          const s = await fetch(`${API_BASE}/api/devices/${encodeURIComponent(deviceId)}`);
          const status = await s.json();
          isActive = !!status?.isActive;
          // Aggiorna badge account
          const acc = document.getElementById('accountStatus');
          if(acc) acc.textContent = isActive ? (lang==='it' ? 'Attivo' : 'Active') : (lang==='it' ? 'In prova' : 'Trial');
        }catch{}

        // Salva localmente per rendering immediato
        const devices = JSON.parse(localStorage.getItem('devices')||'[]');
        devices.push({ ...device, createdAt:new Date().toISOString(), isActive });
        localStorage.setItem('devices', JSON.stringify(devices));
        renderDevices(devices);
        updateStats(devices);

        form.reset();
        document.querySelector('.tab[data-tab="devices"]').click();
        showToast(t[lang].toastSaved);
      }catch(err){
        showToast(t[lang].toastError);
      }
    });

    // =========================
    // Init
    // =========================
    (function init(){
      const lang = localStorage.getItem('lang') || 'it';
      document.getElementById('btn-it').addEventListener('click', ()=>applyLang('it'));
      document.getElementById('btn-en').addEventListener('click', ()=>applyLang('en'));
      applyLang(lang);

      // carica devices locali
      const devices = JSON.parse(localStorage.getItem('devices')||'[]');
      renderDevices(devices); updateStats(devices);

      // contatore attivi fake
      setInterval(()=>{ document.getElementById('activeDevices').textContent = Math.floor(Math.random()*3); }, 5000);
    })();
  </script>
</body>
</html>
